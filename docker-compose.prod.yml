# ============================================================================
# Multi-Agent Platform - Production Docker Compose
# ============================================================================
# Para clientes: Solo necesitan este archivo y un .env
#
# Pasos:
#   1. Crear MongoDB Atlas (https://cloud.mongodb.com)
#   2. Copiar .env.client.template a .env
#   3. Configurar valores en .env
#   4. docker compose up -d
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # Multi-Agent Backend (desde Docker Hub)
  # ============================================================================
  agents-backend:
    image: ${DOCKER_IMAGE:-multiagents/backend:latest}
    container_name: agents-backend
    restart: always
    ports:
      - "${PORT:-3001}:3001"
    environment:
      # Server
      NODE_ENV: production
      PORT: 3001
      
      # Database - MongoDB Atlas (configurar en .env)
      MONGODB_URI: ${MONGODB_URI}
      
      # Workspace - Disco Persistente o local
      AGENT_WORKSPACE_DIR: /data/agent-workspace
      
      # Git timeouts
      GIT_CLONE_TIMEOUT: 600000
      GIT_PUSH_TIMEOUT: 600000
      GIT_COMMIT_TIMEOUT: 300000
      
      # Recovery
      AUTO_RECOVER_ON_STARTUP: "true"
      CANCELLATION_CHECK_INTERVAL_MS: 5000
      
      # Cleanup (DESHABILITADO por defecto)
      WORKSPACE_AUTO_CLEANUP_ENABLED: "${WORKSPACE_AUTO_CLEANUP_ENABLED:-false}"
      WORKSPACE_MAX_AGE_HOURS: "${WORKSPACE_MAX_AGE_HOURS:-168}"
      
      # ===== CONFIGURACIÃ“N DEL CLIENTE (desde .env) =====
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      VOYAGE_API_KEY: ${VOYAGE_API_KEY:-}
      
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      GITHUB_APP_ID: ${GITHUB_APP_ID:-}
      GITHUB_PRIVATE_KEY: ${GITHUB_PRIVATE_KEY:-}
      GITHUB_INSTALLATION_ID: ${GITHUB_INSTALLATION_ID:-}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-}
      
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-${JWT_SECRET}}
      SESSION_SECRET: ${SESSION_SECRET:-${JWT_SECRET}}
      
      BASE_URL: ${BASE_URL:-http://localhost:3001}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      
      REDIS_URL: ${REDIS_URL:-}
      FIREBASE_STORAGE_BUCKET: ${FIREBASE_STORAGE_BUCKET:-}
      FIREBASE_SERVICE_ACCOUNT: ${FIREBASE_SERVICE_ACCOUNT:-}
      
      ENABLE_PERFORMANCE_CACHE: "true"
      ENABLE_FILE_CONTENT_CACHE: "true"
      ENABLE_ENHANCED_GIT_EXECUTION: "true"
      
    volumes:
      # Workspace persistente
      - agents-workspace:/data/agent-workspace
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Volumen para datos persistentes
volumes:
  agents-workspace:
    name: agents-workspace
